name: Auto Post Matches

on:
  schedule:
    - cron: "*/3 * * * *"   # Runs every 3 minutes
  workflow_dispatch: {}

jobs:
  autopost:
    runs-on: ubuntu-latest

    steps:
      - name: Check allowed time window (only run between 12:00–21:00 IST)
        run: |
          # Get current UTC time
          UTC_HOUR=$(date -u +"%H")
          UTC_MINUTE=$(date -u +"%M")

          echo "Current UTC time: ${UTC_HOUR}:${UTC_MINUTE}"

          # Convert UTC to IST (UTC + 5:30)
          UTC_TOTAL_MINUTES=$((10#$UTC_HOUR * 60 + 10#$UTC_MINUTE))
          IST_TOTAL_MINUTES=$((UTC_TOTAL_MINUTES + 330))
          IST_TOTAL_MINUTES=$((IST_TOTAL_MINUTES % 1440))

          IST_HOUR=$((IST_TOTAL_MINUTES / 60))
          IST_MINUTE=$((IST_TOTAL_MINUTES % 60))

          echo "Current IST time: ${IST_HOUR}:${IST_MINUTE}"

          # Allowed window: 12:00 (inclusive) to 21:00 (exclusive)
          if [ $IST_HOUR -lt 12 ] || [ $IST_HOUR -ge 21 ]; then
            echo "⛔ Outside allowed window (12:00–21:00 IST). Exiting run."
            echo "   Current IST: ${IST_HOUR}:${IST_MINUTE}"
            exit 0
          fi

          echo "✅ Inside allowed window (12:00–21:00 IST). Running script."
          echo "   Current IST: ${IST_HOUR}:${IST_MINUTE}"

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      - name: Run post-matches script
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
          BLOG_ID: ${{ secrets.BLOG_ID }}
        run: node post-matches.js
